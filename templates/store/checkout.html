{% extends 'base.html' %}
{% load static %}
{% load jalali %}
{% block title %}پرداخت نهایی{% endblock %}

{% block content %}
<section class="section">
  <div class="container">
    <h1>پرداخت نهایی</h1>
    <div class="checkout-steps checkout-progress progress-2" aria-label="مراحل خرید">
      <div class="progress-track" aria-hidden="true">
        <div class="progress-fill" aria-hidden="true"></div>
      </div>
      <div class="checkout-step is-done">
        <div class="step-circle-wrapper">
          <div class="step-circle">
            <span class="step-number">1</span>
          </div>
        </div>
        <div class="step-label">انتخاب محصولات</div>
      </div>
      <div class="checkout-step is-active" aria-current="step">
        <div class="step-circle-wrapper">
          <div class="step-circle">
            <span class="step-number">2</span>
          </div>
        </div>
        <div class="step-label">ثبت آدرس</div>
      </div>
      <div class="checkout-step">
        <div class="step-circle-wrapper">
          <div class="step-circle">
            <span class="step-number">3</span>
          </div>
        </div>
        <div class="step-label">پرداخت</div>
      </div>
    </div>

    {% if errors and errors.phone_verified %}
      <div class="form-error">{{ errors.phone_verified }}</div>
    {% endif %}
    {% if errors and errors.cart %}
      <div class="form-error">{{ errors.cart }}</div>
    {% endif %}
    {% if removed_unavailable %}
      <div class="form-error">محصولات ناموجود از سبد حذف شدند: {{ removed_unavailable|join:", " }}</div>
    {% endif %}

    <div class="checkout-layout">
      <div class="checkout-form">
        <h2>اطلاعات گیرنده</h2>

        <form method="post" novalidate>
          {% csrf_token %}

          <div class="checkout-grid">
            <div class="checkout-field full">
              <label for="recipient_is_other">
                <input
                  id="recipient_is_other"
                  type="checkbox"
                  name="recipient_is_other"
                  value="1"
                  {% if values.recipient_is_other %}checked{% endif %}
                >
                <span>تحویل‌گیرنده شخص دیگری است</span>
              </label>
            </div>

            <div class="checkout-field">
              <label for="first_name">نام <span class="field-tag required">اجباری</span></label>
              <input id="first_name" type="text" name="first_name" value="{{ values.first_name }}" {% if not values.recipient_is_other %}readonly{% endif %} required>
              {% if errors.first_name %}<div class="field-error">{{ errors.first_name }}</div>{% endif %}
            </div>

            <div class="checkout-field">
              <label for="last_name">نام خانوادگی <span class="field-tag required">اجباری</span></label>
              <input id="last_name" type="text" name="last_name" value="{{ values.last_name }}" {% if not values.recipient_is_other %}readonly{% endif %} required>
              {% if errors.last_name %}<div class="field-error">{{ errors.last_name }}</div>{% endif %}
            </div>

            <div class="checkout-field">
              <label for="phone">شماره موبایل <span class="field-tag required">اجباری</span></label>
              <input id="phone" type="tel" name="phone" value="{{ values.phone }}" inputmode="tel" {% if not values.recipient_is_other %}readonly{% endif %} required>
              {% if errors.phone %}<div class="field-error">{{ errors.phone }}</div>{% endif %}
            </div>

            <div class="checkout-field">
              <label for="email">ایمیل <span class="field-tag optional">اختیاری</span></label>
              <input id="email" type="email" name="email" value="{{ values.email }}" autocomplete="email">
            </div>
          </div>

          <h2 class="checkout-section-title">آدرس ارسال</h2>

          <div class="checkout-grid">
            <div class="checkout-field">
              <label for="province-select">استان <span class="field-tag required">اجباری</span></label>
              <select id="province-select" name="province" data-selected="{{ values.province }}" required>
                <option value="">استان را انتخاب کنید</option>
              </select>
              {% if errors.province %}<div class="field-error">{{ errors.province }}</div>{% endif %}
            </div>

            <div class="checkout-field">
              <label for="city-select">شهر <span class="field-tag required">اجباری</span></label>
              <select id="city-select" name="city" data-selected="{{ values.city }}" disabled required>
                <option value="">ابتدا استان را انتخاب کنید</option>
              </select>
              {% if errors.city %}<div class="field-error">{{ errors.city }}</div>{% endif %}
            </div>

            <div class="checkout-field full">
              <label for="address">آدرس دقیق <span class="field-tag required">اجباری</span></label>
              <textarea id="address" name="address" rows="3" required>{{ values.address }}</textarea>
              {% if errors.address %}<div class="field-error">{{ errors.address }}</div>{% endif %}
            </div>

            <div class="checkout-field full">
              <label for="note">توضیحات سفارش <span class="field-tag optional">اختیاری</span></label>
              <textarea id="note" name="note" rows="3">{{ values.note }}</textarea>
            </div>

            <div class="checkout-field full">
              <label for="discount_code">کد تخفیف <span class="field-tag optional">اختیاری</span></label>
              <div class="discount-inline">
                <input id="discount_code" type="text" name="discount_code" value="{{ values.discount_code }}" autocomplete="off">
                <button type="button" id="discount-apply-btn" class="btn btn-outline small">اعمال کد</button>
              </div>
              <input type="hidden" id="discount_code_applied" name="discount_code_applied" value="{{ discount_code }}">
              {% if errors.discount_code %}
                <div id="discount-feedback" class="discount-feedback error">{{ errors.discount_code }}</div>
              {% elif discount_info %}
                <div id="discount-feedback" class="discount-feedback info">{{ discount_info }}</div>
              {% elif discount_code and discount_percent %}
                <div id="discount-feedback" class="discount-feedback ok">کد <strong dir="ltr">{{ discount_code }}</strong> اعمال شد ({{ discount_percent }}٪).</div>
              {% else %}
                <div id="discount-feedback" class="discount-feedback hidden"></div>
              {% endif %}
            </div>
          </div>
          <div class="checkout-field full">
            <label class="inline-check">
              <input type="checkbox" name="accept_terms" value="1" required>
              <span>با <a href="{% url 'terms' %}" target="_blank">قوانین و مقررات</a> و <a href="{% url 'privacy' %}" target="_blank">سیاست حریم خصوصی</a> موافقم.</span>
            </label>
            <label class="inline-check">
              <input type="checkbox" name="optin_email" value="1" {% if values.optin_email %}checked{% endif %}>
              <span>مایلم ایمیل‌های اطلاع‌رسانی/تخفیفی دریافت کنم.</span>
            </label>
            <label class="inline-check">
              <input type="checkbox" name="optin_sms" value="1" {% if values.optin_sms %}checked{% endif %}>
              <span>مایلم پیامک‌های اطلاع‌رسانی/تخفیفی دریافت کنم.</span>
            </label>
          </div>

          <button type="submit" class="btn btn-primary">ثبت اطلاعات و ادامه پرداخت</button>
        </form>
      </div>

      <div
        class="checkout-summary"
        id="checkout-summary"
        data-subtotal="{{ subtotal }}"
        data-items-subtotal="{{ items_subtotal }}"
        data-shipping-fee-per-item="{{ shipping_fee_per_item }}"
        data-item-count="{{ shipping_item_count }}"
        data-free-threshold="{{ free_shipping_min_total }}"
        data-discount-preview-url="{% url 'discount_preview' %}"
      >
        <h2>خلاصه سفارش</h2>

        {% if cart_items %}
          <ul class="checkout-items">
            {% for item in cart_items %}
              <li class="checkout-item{% if not item.product.is_available %} unavailable{% endif %}">
                <div class="checkout-item-main">
                  <div class="checkout-item-name">
                    {{ item.product.name }}
                    {% if not item.product.is_available %}
                      <span class="stock-badge out">ناموجود</span>
                    {% endif %}
                  </div>
                  <div class="checkout-item-meta">{{ item.quantity }} × {{ item.product.price|money }} تومان</div>
                </div>
                <div class="checkout-item-total">{{ item.total_price|money }} تومان</div>
              </li>
            {% endfor %}
          </ul>

          <div class="summary-divider"></div>

          <div class="summary-row">
            <span>جمع کالاها</span>
            <strong>{{ items_subtotal|money }}</strong>
            <span>تومان</span>
          </div>

          <div id="discount-row" class="summary-row {% if not discount_amount %}hidden{% endif %}">
            <span>تخفیف (<span id="discount-percent">{{ discount_percent|default_if_none:0 }}</span>٪)</span>
            <strong id="discount-amount" dir="ltr">-{{ discount_amount|money }}</strong>
            <span>تومان</span>
          </div>

          <div class="summary-row">
            <span id="subtotal-label">{% if discount_amount %}جمع پس از تخفیف{% else %}جمع کل کالاها{% endif %}</span>
            <strong id="checkout-subtotal">{{ subtotal|money }}</strong>
            <span>تومان</span>
          </div>

          <div class="summary-row">
            <span>هزینه ارسال ({{ shipping_item_count }} مورد × {{ shipping_fee_per_item|money }} تومان)</span>
            <div class="summary-price">
              <span id="shipping-fee-original" class="summary-strike {% if not shipping_is_free %}hidden{% endif %}">{{ shipping_total_full|money }}</span>
              <strong id="shipping-fee">{{ shipping_applied|money }}</strong>
              <span class="summary-currency">تومان</span>
              <span id="shipping-free-badge" class="summary-badge {% if not shipping_is_free %}hidden{% endif %}">ارسال رایگان شد</span>
            </div>
          </div>

          <div id="shipping-hint" class="shipping-hint {% if shipping_applicable %}hidden{% endif %}">برای محاسبه هزینه ارسال، استان را انتخاب کنید.</div>

          <div class="summary-row total">
            <span>مبلغ نهایی</span>
            <strong id="final-total">{{ total_payable|money }}</strong>
            <span>تومان</span>
          </div>
        {% else %}
          <p class="empty-text">سبد خرید شما خالی است.</p>
        {% endif %}
      </div>
    </div>
  </div>
</section>

{% endblock %}

{% block extra_js %}
  <script src="{% static 'js/iran-locations.js' %}" defer></script>
  <script src="{% static 'js/checkout.js' %}" defer></script>
{% endblock %}
