{% extends 'base.html' %}
{% load static %}
{% load jalali %}
{% block title %}فروشگاه - استیرا{% endblock %}

{% block content %}
<section class="section page-hero">
  <div class="container">
    <h1>فروشگاه</h1>
    <p>بهترین تجهیزات و لوازم فروشگاهی را با ارسال سریع و پشتیبانی دائمی تهیه کنید.</p>

    <div class="shop-filters">
      <form method="get" class="filters">
        <div class="filter-row">
          <div class="filter-group">
            <label>دسته‌بندی</label>
            <select name="category">
              <option value="">همه دسته‌ها</option>
              {% for cat in categories %}
                <option value="{{ cat.id }}" {% if filters.category == cat.id|stringformat:'s' %}selected{% endif %}>
                  {{ cat.name }}
                </option>
              {% endfor %}
            </select>
          </div>
          <div class="filter-group">
            <label>برند</label>
            <select name="brand">
              <option value="">همه برندها</option>
              {% for brand_name in brands %}
                <option value="{{ brand_name }}" {% if filters.brand == brand_name %}selected{% endif %}>
                  {{ brand_name }}
                </option>
              {% endfor %}
            </select>
          </div>
          <div class="filter-group">
            <label>جست‌وجو</label>
            <input
              type="text"
              name="domain"
              placeholder="نام محصول یا حوزه کاربرد"
              value="{{ filters.domain }}"
              list="shop-suggestions"
              data-suggest-url="{% url 'shop_suggest' %}"
            >
            <datalist id="shop-suggestions"></datalist>
          </div>
          <div class="filter-group">
            <label>مرتب‌سازی</label>
            <select name="sort">
              <option value="newest" {% if filters.sort == 'newest' %}selected{% endif %}>جدیدترین</option>
              <option value="cheapest" {% if filters.sort == 'cheapest' %}selected{% endif %}>ارزان‌ترین</option>
              <option value="bestseller" {% if filters.sort == 'bestseller' %}selected{% endif %}>پرفروش</option>
              <option value="most_viewed" {% if filters.sort == 'most_viewed' %}selected{% endif %}>پربازدید</option>
            </select>
          </div>
        </div>

        <div class="filter-row filter-row--compact">
          <div class="filter-group filter-range">
            <label>بازه قیمت (تومان)</label>
            <div class="range-inputs">
              <input type="text" name="min_price" placeholder="حداقل" value="{{ filters.min_price }}">
              <span class="range-separator">تا</span>
              <input type="text" name="max_price" placeholder="حداکثر" value="{{ filters.max_price }}">
            </div>
          </div>
          <div class="filter-group">
            <label>موجودی</label>
            <select name="availability">
              <option value="">همه</option>
              <option value="in_stock" {% if filters.availability == 'in_stock' %}selected{% endif %}>موجود</option>
              <option value="out_of_stock" {% if filters.availability == 'out_of_stock' %}selected{% endif %}>ناموجود</option>
            </select>
          </div>
          <div class="filter-group filter-actions">
            <button class="animated-button" type="submit">
              <svg xmlns="http://www.w3.org/2000/svg" class="arr-2" viewBox="0 0 24 24">
                <path d="M16.1716 10.9999L10.8076 5.63589L12.2218 4.22168L20 11.9999L12.2218 19.778L10.8076 18.3638L16.1716 12.9999H4V10.9999H16.1716Z"></path>
              </svg>
              <span class="text">اعمال فیلتر</span>
              <span class="circle"></span>
              <svg xmlns="http://www.w3.org/2000/svg" class="arr-1" viewBox="0 0 24 24">
                <path d="M16.1716 10.9999L10.8076 5.63589L12.2218 4.22168L20 11.9999L12.2218 19.778L10.8076 18.3638L16.1716 12.9999H4V10.9999H16.1716Z"></path>
              </svg>
            </button>
            <a class="animated-button" href="{% url 'shop' %}">
              <svg xmlns="http://www.w3.org/2000/svg" class="arr-2" viewBox="0 0 24 24">
                <path d="M16.1716 10.9999L10.8076 5.63589L12.2218 4.22168L20 11.9999L12.2218 19.778L10.8076 18.3638L16.1716 12.9999H4V10.9999H16.1716Z"></path>
              </svg>
              <span class="text">حذف فیلتر</span>
              <span class="circle"></span>
              <svg xmlns="http://www.w3.org/2000/svg" class="arr-1" viewBox="0 0 24 24">
                <path d="M16.1716 10.9999L10.8076 5.63589L12.2218 4.22168L20 11.9999L12.2218 19.778L10.8076 18.3638L16.1716 12.9999H4V10.9999H16.1716Z"></path>
              </svg>
            </a>
          </div>
        </div>

        <div class="filter-tags">
          <span class="filter-label">پیشنهاد جستجو:</span>
          <button type="button" class="filter-chip" data-tag="یخچال">یخچال</button>
          <button type="button" class="filter-chip" data-tag="فر پیتزا">فر پیتزا</button>
          <button type="button" class="filter-chip" data-tag="ویترین">ویترین</button>
          <button type="button" class="filter-chip" data-tag="سینی">سینی</button>
          <button type="button" class="filter-chip" data-tag="سرخ‌کن">سرخ‌کن</button>
        </div>
      </form>
    </div>
  </div>
</section>

<section class="section">
  <div class="container">
    <div class="products-grid">
      {% for product in products %}
        <div class="product-card{% if not product.is_available %} unavailable{% endif %}" data-product-card data-href="{% url 'product_detail' product.id %}">
        <div class="product-image">
            {% if product.card_image_url %}
                <img src="{{ product.card_image_url }}" alt="{{ product.name }}" loading="lazy" decoding="async">
              {% else %}
                <picture>
                  <source srcset="{% static 'img/product-placeholder.webp' %}" type="image/webp">
                  <img src="{% static 'img/product-placeholder.jpg' %}" alt="{{ product.name }}" loading="lazy" decoding="async">
                </picture>
              {% endif %}
            {% if not product.is_available %}
              <span class="product-badge unavailable">ناموجود</span>
            {% endif %}
        </div>

          <div class="product-info">
            <h3>{{ product.name }}</h3>
            <p class="product-domain">{{ product.domain }}</p>
            <p class="product-price">{{ product.price|money }} تومان</p>
            <div class="product-metrics">
              <span>فروش: {{ product.sales_count|money }}</span>
            </div>

            <div class="product-actions" data-no-card-nav>
              <a href="{% url 'add_to_compare' product.id %}" class="btn btn-outline small">مقایسه</a>
            </div>
          </div>

          <div class="product-card-cart" data-no-card-nav>
            <div class="checkbox-container">
              <div class="checkbox-wrapper">
                <input
                  class="checkbox"
                  id="cart-toggle-{{ product.id }}"
                  type="checkbox"
                  data-cart-toggle
                  data-product-id="{{ product.id }}"
                  data-add-url="{% if product.is_available %}{% url 'add_to_cart' product.id %}?next={{ request.get_full_path|urlencode }}&qty=1{% endif %}"
                  data-remove-url="{% url 'cart_remove' %}"
                  {% if product.id in cart_product_ids %}checked{% endif %}
                  {% if not product.is_available %}disabled aria-disabled="true"{% endif %}
                />
                <label class="checkbox-label" for="cart-toggle-{{ product.id }}">
                  <div class="checkbox-flip">
                    <div class="checkbox-front" aria-hidden="true">
                      <svg fill="white" height="28" width="28" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path
                          d="M19 13H12V19H11V13H5V12H11V6H12V12H19V13Z"
                          class="icon-path"
                        ></path>
                      </svg>
                    </div>
                    <div class="checkbox-back" aria-hidden="true">
                      <svg fill="white" height="28" width="28" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path
                          d="M9 19l-7-7 1.41-1.41L9 16.17l11.29-11.3L22 6l-13 13z"
                          class="icon-path"
                        ></path>
                      </svg>
                    </div>
                  </div>
                </label>
              </div>
            </div>
          </div>
        </div>
      {% empty %}
        <p class="empty-text">محصولی یافت نشد.</p>
      {% endfor %}
    </div>
  </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
  document.querySelectorAll('.filter-chip').forEach(chip => {
    chip.addEventListener('click', () => {
      const tag = chip.dataset.tag;
      const input = document.querySelector('input[name="domain"]');
      input.value = tag;
      input.form.submit();
    });
  });
</script>
<script src="{% static 'js/shop-suggest.js' %}" defer></script>
<script src="{% static 'js/shop.js' %}" defer></script>
{% endblock %}
