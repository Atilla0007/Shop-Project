{% extends 'base.html' %}
{% load static %}
{% load jalali %}

{% block title %}پروفایل{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/profile.css' %}">
{% endblock %}

{% block content %}
<section class="profile-shell">
  <div class="container profile-grid">
    <aside class="profile-card">
      <div class="profile-header">
        <div class="avatar">{{ request.user.username|slice:':1'|upper }}</div>
        <div>
          <h2 class="profile-name">{{ request.user.get_full_name|default:request.user.username }}</h2>
          <p class="profile-sub" dir="ltr">{{ request.user.email|default:'-' }}</p>
        </div>
      </div>

      <div class="profile-badges">
        {% if profile.phone %}
          {% if profile.phone_verified %}
            <span class="badge ok">شماره موبایل تایید شده</span>
          {% else %}
            <span class="badge warn">شماره موبایل تایید نشده</span>
          {% endif %}
        {% else %}
          <span class="badge info">شماره موبایل وارد نشده</span>
        {% endif %}

        {% if profile.email_verified %}
          <span class="badge ok">ایمیل تایید شده</span>
        {% else %}
          <span class="badge warn">ایمیل تایید نشده</span>
        {% endif %}
      </div>

      {% if profile.email_verified %}
        <div class="email-verify-done">ایمیل تایید شده است</div>
      {% else %}
        <a class="email-verify-cta" href="{% url 'email_otp_verify_page' %}?next={% url 'profile' %}">
          برای تایید ایمیل کلیک کنید
        </a>
      {% endif %}

      {% if profile.phone %}
        {% if profile.phone_verified %}
          <div class="phone-verify-done">شماره موبایل تایید شده است</div>
        {% else %}
          <a class="phone-verify-cta" href="{% url 'phone_otp_verify_page' %}?next={% url 'profile' %}">
            برای تایید شماره موبایل کلیک کنید
          </a>
        {% endif %}
      {% endif %}

      <div class="profile-info">
        <div class="row"><span>نام</span><strong>{{ request.user.first_name|default:'-' }}</strong></div>
        <div class="row"><span>نام خانوادگی</span><strong>{{ request.user.last_name|default:'-' }}</strong></div>
        <div class="row"><span>ایمیل</span><strong dir="ltr">{{ request.user.email|default:'-' }}</strong></div>
        <div class="row"><span>موبایل</span><strong dir="ltr">{{ profile.phone|default:'-' }}</strong></div>
      </div>

      <div class="profile-actions">
        <a class="btn btn-primary" href="{% url 'profile_edit' %}">ویرایش اطلاعات</a>
      </div>
    </aside>

    <main class="orders-card">
      <div class="orders-header">
        <h2>سفارش‌های قبلی</h2>
        <p class="muted">کد رهگیری فعلاً همان شماره سفارش است.</p>
      </div>

      {% if orders %}
        <div class="orders-list">
          {% for o in orders %}
            <div class="order-item">
              <div class="order-top">
                <div>
                  <div class="order-title">سفارش #{{ o.id }}</div>
                  <div class="order-meta">تاریخ: {{ o.created_at|jalali:"Y/m/d" }} | وضعیت: {{ o.get_status_display }}</div>
                </div>
                <div class="order-price">{{ o.total_price|money }} تومان</div>
              </div>

              <div class="tracking">
                <span>کد رهگیری:</span>
                <code>{{ o.id }}</code>
              </div>

              {% if o.items.all %}
              <ul class="order-lines">
                {% for it in o.items.all %}
                  <li>{{ it.product.name }} | تعداد: {{ it.quantity }}</li>
                {% endfor %}
              </ul>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="empty">هنوز سفارشی ثبت نکرده‌اید.</p>
      {% endif %}
    </main>
  </div>
</section>
{% endblock %}
