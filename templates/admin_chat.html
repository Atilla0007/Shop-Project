{% extends 'base.html' %}
{% load static %}
{% load jalali %}
{% block title %}Ù¾Ù†Ù„ Ú†Øª Ø§Ø¯Ù…ÛŒÙ†{% endblock %}

{% block content %}
<section class="section">
    <div class="container admin-chat-layout">
        <!-- Ù„ÛŒØ³Øª Ú¯ÙØªÚ¯ÙˆÙ‡Ø§ -->
        <aside class="admin-chat-sidebar">
            <h3>Ú¯ÙØªÚ¯ÙˆÙ‡Ø§</h3>
            <div class="admin-chat-thread-list">
                {% for t in threads %}
                    <a href="{% url 'admin_chat_detail' t.user.id %}"
                       class="thread-item {% if active_thread and active_thread.id == t.id %}active{% endif %}">
                        <div class="thread-main">
                            <span class="thread-user">{{ t.user.username }}</span>
                            <span class="thread-time">
                                {% if t.last_time %}
                                    {{ t.last_time|jalali:"H:i" }}
                                {% endif %}
                            </span>
                        </div>
                        {% if t.unread_count %}
                            <span class="thread-unread">{{ t.unread_count }}</span>
                        {% endif %}
                    </a>
                {% empty %}
                    <p class="empty-text">Ú¯ÙØªÚ¯ÙˆÛŒÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</p>
                {% endfor %}
            </div>
        </aside>

        <!-- Ù¾Ù†Ø¬Ø±Ù‡ Ú†Øª -->
        <div class="admin-chat-main">
            {% if active_thread %}
                <div class="admin-chat-header">
                    <div>
                        <button type="button" class="link-button" id="toggle-user-panel">
                            {{ active_thread.user.username }}
                        </button>
                        <span class="admin-chat-sub">
                            Ú¯ÙØªÚ¯Ùˆ Ø¨Ø§ Ú©Ø§Ø±Ø¨Ø±
                        </span>
                    </div>
                </div>

                <div id="admin-chat-box"
                     class="admin-chat-box"
                     data-user-id="{{ active_thread.user.id }}">
                    <!-- Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ø¨Ø§ JavaScript Ù„ÙˆØ¯ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
                </div>

                <div class="admin-quick-replies">
                    <span>Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø¢Ù…Ø§Ø¯Ù‡:</span>
                    <button type="button" class="chip quick-reply">Ø³Ù„Ø§Ù…ØŒ ÙˆÙ‚Øª Ø´Ù…Ø§ Ø¨Ø®ÛŒØ±. Ú†Ø·ÙˆØ± Ù…ÛŒâ€ŒØªÙˆÙ†Ù… Ú©Ù…Ú©ØªÙˆÙ† Ú©Ù†Ù…ØŸ</button>
                    <button type="button" class="chip quick-reply">Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ Ø«Ø¨Øª Ø´Ø¯ Ùˆ Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø§Ø³Øª ğŸŒŸ</button>
                    <button type="button" class="chip quick-reply">Ù„Ø·ÙØ§Ù‹ Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ ÛŒØ§ Ù†Ø§Ù… Ù…Ø¬Ù…ÙˆØ¹Ù‡ Ø±Ø§ Ø¨ÙØ±Ù…Ø§ÛŒÛŒØ¯.</button>
                </div>

                <form id="admin-chat-form" class="admin-chat-form">
                    {% csrf_token %}
                    <div class="messageBox">
                        <div class="fileUploadWrapper">
                            <label for="admin-chat-file">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 337 337" aria-hidden="true">
                                    <circle stroke-width="20" stroke="#6c6c6c" fill="none" r="158.5" cy="168.5" cx="168.5"></circle>
                                    <path stroke-linecap="round" stroke-width="25" stroke="#6c6c6c" d="M167.759 79V259"></path>
                                    <path stroke-linecap="round" stroke-width="25" stroke="#6c6c6c" d="M79 167.138H259"></path>
                                </svg>
                                <span class="tooltip">Ø§ÙØ²ÙˆØ¯Ù† ØªØµÙˆÛŒØ±</span>
                            </label>
                            <input type="file" id="admin-chat-file" name="file" accept="image/*" />
                        </div>

                        <input type="text" id="admin-chat-input" class="messageBox-input" required placeholder="Ù¾Ø§Ø³Ø® Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..." autocomplete="off">

                        <button type="submit" class="messageBox-send" aria-label="Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…">
                            <span class="visually-hidden">Ø§Ø±Ø³Ø§Ù„</span>
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 664 663" aria-hidden="true">
                                <path fill="none" d="M646.293 331.888L17.7538 17.6187L155.245 331.888M646.293 331.888L17.753 646.157L155.245 331.888M646.293 331.888L318.735 330.228L155.245 331.888"></path>
                                <path stroke-linejoin="round" stroke-linecap="round" stroke-width="33.67" stroke="#6c6c6c" d="M646.293 331.888L17.7538 17.6187L155.245 331.888M646.293 331.888L17.753 646.157L155.245 331.888M646.293 331.888L318.735 330.228L155.245 331.888"></path>
                            </svg>
                        </button>
                    </div>
                </form>
            {% else %}
                <div class="admin-chat-empty">
                    <p class="empty-text">Ú¯ÙØªÚ¯ÙˆÛŒÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>
                </div>
            {% endif %}
        </div>

        <!-- Ù¾Ù†Ù„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø± / Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§ -->
        <aside class="admin-chat-user-panel {% if not active_thread %}hidden{% endif %}" id="admin-user-panel">
            {% if active_thread and active_thread.user %}
                <h3>Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±</h3>
                <div class="user-info-block">
                    <div class="user-info-row">
                        <span>Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ:</span>
                        <strong>{{ active_thread.user.username }}</strong>
                    </div>
                    <div class="user-info-row">
                        <span>Ø§ÛŒÙ…ÛŒÙ„:</span>
                        <strong>{{ active_thread.user.email|default:"-" }}</strong>
                    </div>
                    <div class="user-info-row">
                        <span>ØªØ§Ø±ÛŒØ® Ø¹Ø¶ÙˆÛŒØª:</span>
                        <strong>{{ active_thread.user.date_joined|jalali:"j F Y" }}</strong>
                    </div>
                </div>

                <h4>Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§</h4>
                <div class="user-orders-list">
                    {% if user_orders %}
                        {% for order in user_orders %}
                            <div class="order-card">
                                <div class="order-header">
                                    <span>Ø³ÙØ§Ø±Ø´ #{{ order.id }}</span>
                                    <span class="order-status">{{ order.get_status_display }}</span>
                                </div>
                                <div class="order-meta">
                                    <span>{{ order.created_at|jalali:"j F Y - H:i" }}</span>
                                    <span>{{ order.total_price|money }} ØªÙˆÙ…Ø§Ù†</span>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p class="empty-text">Ø§ÛŒÙ† Ú©Ø§Ø±Ø¨Ø± Ù‡Ù†ÙˆØ² Ø³ÙØ§Ø±Ø´ÛŒ Ø«Ø¨Øª Ù†Ú©Ø±Ø¯Ù‡ Ø§Ø³Øª.</p>
                    {% endif %}
                </div>
            {% endif %}
        </aside>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/admin_chat.js' %}"></script>
{% endblock %}
